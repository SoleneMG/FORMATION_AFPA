/*1322466278,169776066*/

if (window.CavalryLogger) { CavalryLogger.start_js(["LkeiP"]); }

var ChannelRebuildReasons={Unknown:0,AsyncError:1,TooLong:2,Refresh:3,RefreshDelay:4,UIRestart:5,NeedSeq:6,PrevFailed:7,IFrameLoadGiveUp:8,IFrameLoadRetry:9,IFrameLoadRetryWorked:10,PageTransitionRetry:11,IFrameLoadMaxSubdomain:12,NoChannelInfo:13,NoChannelHost:14,ChannelUnknown:100,ChannelNoCUser:101,ChannelInvalidCUser:102,ChannelInvalidChanstr:103,ChannelChDistribTimeout:104,ChannelGetChannelOther:105,ChannelNodeShutdown:106,ChannelTermination:107,ChannelUserMismatch:108,ChannelUserMismatchShady:109,ChannelBadXs:110,ChannelSeqNeg:111,ChannelSeqTooBig:112,ChannelSeqTooSmall:113,ChannelUnexpectedJoin:114,ChannelInvalidXsCookie:115,ChannelRelocate:116,ChannelWrongPartition:117};
var CrossDocument={};(function(){CrossDocument.setListener=function(eventHandler){if(window.postMessage){if(window.addEventListener){window.addEventListener('message',eventHandler,false);}else window.onmessage=eventHandler;}else if(document.postMessage)document.addEventListener('message',eventHandler,false);};CrossDocument.mkPostMessage=function(targetWindow,targetDocument,msgHandler){if(window.postMessage){if("object"==typeof window.postMessage){return function(message,origin){targetWindow.postMessage(message,origin);};}else return bind(targetWindow,targetWindow.postMessage);}else if(document.postMessage){return bind(targetDocument,targetDocument.postMessage);}else return bind(targetWindow,msgHandler);};CrossDocument.targetOrigin=function(parent){if(window.postMessage||document.postMessage){var parentLoc=parent.location;var parentHost=parentLoc.hostname;if(parentHost=='facebook.com'||parentHost.substring(parentHost.length-13)=='.facebook.com')return parentLoc.protocol+'//'+parentLoc.host;}else return null;};var _handleMessage=function(msgCallback,msgStr){if(!msgStr||msgStr.charAt(0)!='{')return;var msg=eval('('+msgStr+')');return msgCallback(msg);};CrossDocument.mkEventHandler=function(msgCallback){return function(event){event=event||window.event;var domain=(event.domain||event.origin);if(domain.substring(domain.length-13)!='.facebook.com'&&domain.substring(domain.length-15)!='://facebook.com'&&domain!='facebook.com')return;return _handleMessage(msgCallback,event.data);};};CrossDocument.mkMessageHandler=function(msgCallback){return function(msgStr){return _handleMessage(msgCallback,msgStr);};};})();
__e("PresenceUtil",["cookie"],function(d,f,e,c){var a=f('cookie');var b=Math.floor(Math.random()*4294967295)+1;d.PresenceUtil=e.exports={getSessionID:function(){return b;},hasUserCookie:function(){return Env.user===a.get('c_user');}};},3);
var ChatUserInfos=window.ChatUserInfos||{};function getUserInfo(a){return window.ChatUserInfos[a]&&copy_properties({},window.ChatUserInfos[a]);}function setUserInfo(a,b){var c=window.ChatUserInfos[a];if(c&&(c.name!=b.name||c.firstName!=b.firstName||c.thumbSrc!=b.thumbSrc))JSLogger.create('user_infos').warn('changed',{oldInfo:c,newInfo:b});window.ChatUserInfos[a]=copy_properties({},b);}function getFirstName(c){var d=c.split(" ");var b=d[0];var a=b.length;if(typeof d[1]!='undefined'&&(a==1||(a==2&&b.indexOf('.')!=-1)||(a==3&&b.toLowerCase()=='the')))b+=' '+d[1];return b;}
__e("ChatConfig",["ChatConfigInitialData","copyProperties"],function(f,h,g,e){var b=h('ChatConfigInitialData');var d=h('copyProperties');var c={};var a=g.exports={get:function(j,i){return j in c?c[j]:i;},set:function(i){if(arguments.length>1){var j={};j[i]=arguments[1];i=j;}d(c,i);},getDebugInfo:function(){return c;}};a.set(b);},3);
__e("dcode",[],function(d,f,e,c){var a,g={},b={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};(function(){var i=[];for(var h in b){g[b[h]]=h;i.push(b[h]);}i.reverse();a=new RegExp(i.join("|"),'g');})();d.Dcode=e.exports={encode:function(h){return encodeURIComponent(h).replace(/([_A-Z])|%../g,function(j,i){return i?'%'+i.charCodeAt(0).toString(16):j;}).toLowerCase().replace(a,function(i){return g[i];});},decode:function(h){return decodeURIComponent(h.replace(/[_A-Z]/g,function(i){return b[i];}));}};},3);
__e("presence-cookie-manager",["cookie","dcode","JSLogger","json","PresenceInitialData","PresenceUtil"],function(p,r,q,o){p.CookieManager=function(){};var a=r('cookie');var b=r('dcode');var c=r('JSLogger');r('json');var d=r('PresenceInitialData');var e=r('PresenceUtil');var n=d.cookieVersion;var g=d.dictEncode;var f='presence';var m={};var j=null;var k=null;var i=c.create('presence_cookie');function h(){try{var data=a.get(f);if(j===data){return k;}else{j=data;k=null;}if(data&&data.charAt(0)=='E')data=b.decode(data.substring(1));if(data){k=JSON.parse(data);return k;}}catch(s){i.warn('getcookie_error');}return null;}function l(){return parseInt(new Date().getTime()/1000,10);}p.presenceCookieManager=q.exports={register:function(t,s){m[t]=s;},store:function(){var s=h();if(s&&s.v&&n<s.v)return;var t={v:n,time:l()};for(var v in m)t[v]=m[v]();var u=JSON.stringify(t);if(g)u='E'+b.encode(u);if(e.hasUserCookie())a.set(f,u,null);},clear:function(){a.clear(f);},getSubCookie:function(t){var s=h();if(!s)return null;return s[t];}};},3);
__e("ChatTabModel",["ArrayUtils","MercuryAssert","presence","copyProperties","arbiter"],function(y,zb,z,x){var b=zb('ArrayUtils');var c=zb('MercuryAssert');var za=zb('presence');var w=zb('copyProperties');var u=[];var h=[];var r=null;var q=null;var j=0;var m=20;var i=JSLogger.create('chat_tab_model');var s=false;function t(zc){zc.t2=u.map(function(zd){return {i:zd};});zc.f2=r;zc.uct2=j;zc.lm2=q;return zc;}function k(zd){if(zd){var ze=verifyNumber(zd.uct2);if(ze>j){j=ze;i.log('load_cookie_tabs',{tabs:zd.t2,raised:zd.f2,promoted:zd.lm2});if(zd.t2){var zc=b.createFrom(zd.t2).map(function(zf){return zf.i;});l(zc,zd.f2||null,zd.lm2||null);}}}}function l(ze,zd,zc){if(v(ze,zd,zc)){if(ze.indexOf(zd)===-1)zd=null;if(ze.indexOf(zc)===-1)zc=null;u=ze;r=zd;q=zc;g();n();}}function v(zg,zf,ze){if(zf!=r)return true;if(ze!=q)return true;if(zg.length!=u.length)return true;for(var zc=0,zd=zg.length;zc<zd;zc++)if(zg[zc]!=u[zc])return true;return false;}function n(){if(s)ChatTabModel.inform('chat/tabs-changed',ChatTabModel.get());}function f(){j=Math.floor(Date.now()*.001);za.doSync();n();}function g(){var zc=u.length-m;if(zc>0)u=u.filter(function(zd){return zd==r||zc--<=0;});}function o(zc){if(u.indexOf(zc)===-1&&h.indexOf(zc)===-1){h.push(zc);return true;}return false;}function p(zd){var zc=d(zd);if(u.indexOf(zd)===-1){u.push(zd);g();zc=true;}return zc;}function d(zc){if(h.indexOf(zc)!==-1){h=h.filter(function(zd){return zd!=zc;});return true;}return false;}function e(zc){if(u.indexOf(zc)!==-1){u=u.filter(function(zd){return zd!=zc;});return true;}return false;}za.registerStateStorer(t);za.registerStateLoader(k);var a=zb('arbiter');z.exports=ChatTabModel=w(new a(),{closeAllTabs:function(){if(u.length!==0||h.length!==0){u=[];h=[];r=null;q=null;f();}},closeFragileTabs:function(){if(h.length){h=[];n();}},closeTab:function(zd){c.isThreadID(zd);var zc=e(zd);zc|=d(zd);if(zc){if(r==zd)r=null;if(q==zd)q=null;f();}},raiseTab:function(zc){c.isThreadID(zc);p(zc);if(r!=zc){r=zc;f();}},get:function(){var zc=u.concat(h);return {tabs:zc,raised:r,promoted:q};},openFragileTab:function(zc){c.isThreadID(zc);if(o(zc))n();},openTab:function(zc){c.isThreadID(zc);if(p(zc))f();},lowerTab:function(zc){c.isThreadID(zc);if(r==zc){r=null;f();}},raiseAndPromoteTab:function(zc){c.isThreadID(zc);p(zc);if(r!=zc||q!=zc){r=q=zc;f();}}});k(za.state,true);s=true;});
__e("ChatController",["ChatTabModel","MercuryThreads"],function(d,f,e,c){var a=f('ChatTabModel');var b=f('MercuryThreads');e.exports={raiseFragileGroupTab:function(g){b.getCanonicalThreadToGroup(g,function(h){a.openFragileTab(h.thread_id);});},raiseGroupTab:function(g){b.getCanonicalThreadToGroup(g,function(h){a.raiseTab(h.thread_id);});}};});
var PresencePrivacy=window.PresencePrivacy||(function(){var a='/ajax/chat/privacy/settings.php';var b='/ajax/chat/privacy/online_policy.php';var c='/ajax/chat/privacy/visibility.php';var j={};var v;var m={};var n;var i;var l;var s=[];var q=false;var k=false;function d(){return Chat.getLogger('blackbird');}function g(w,x){if(w==Env.user)return;switch(x){case PresencePrivacy.WHITELISTED:case PresencePrivacy.BLACKLISTED:case PresencePrivacy.UNLISTED:break;default:return;}j[w]=x;PresencePrivacy.inform('privacy-changed');}function h(w){switch(w){case PresencePrivacy.ONLINE:case PresencePrivacy.OFFLINE:break;default:return;}v=w;PresencePrivacy.inform('privacy-changed');PresencePrivacy.inform('privacy-user-presence-changed');Arbiter.inform('chat/visibility-changed',{sender:this});}function f(w){switch(w){case PresencePrivacy.ONLINE_TO_WHITELIST:case PresencePrivacy.ONLINE_TO_BLACKLIST:break;default:return;}i=w;PresencePrivacy.inform('privacy-user-presence-changed');PresencePrivacy.inform('privacy-changed');}function t(x,w){s.push({uri:x,data:w});if(!q){next=s.shift();u(next.uri,next.data);}}function u(x,w){require.ensure(['PresenceUtil'],function(y){q=true;w.window_id=y.getSessionID();new AsyncRequest().setURI(x).setData(w).setHandler(r.bind(this,x,w)).setErrorHandler(o.bind(this,w)).setTransportErrorHandler(o.bind(this,w)).setFinallyHandler(p.bind(this)).setAllowCrossPageTransition(true).send();}.bind(this));}function r(y,w,x){if(y===a){var za=x.payload.user_availabilities;PresencePrivacy.inform('privacy-availability-changed',{user_availabilities:za});for(var z in za)m[z]=w.setting;}else{if(y===c){n=w.visibility;}else if(y===b)l=w.online_policy;PresencePrivacy.inform('privacy-user-presence-response');}d().log('set_update_response',{data:w,response:x});}function o(w,x){if(v!==n)h(n);if(i!==l)f(l);copy_properties(j,m);PresencePrivacy.inform('privacy-changed');s=[];d().log('set_error_response',{data:w,response:x});}function p(w){q=false;if(s.length>0){next=s.shift();u(next.uri,next.data);}}function e(x,w){require.ensure(['PresenceUtil'],function(y){var zb=w.obj;if(zb.window_id===y.getSessionID())return;var z=zb.data;if(zb.event=='access_control_entry'){g(z.target_id,z.setting);m[z.target_id]=z.setting;}else{if(zb.event=='visibility_update'){var za=!!z.visibility?PresencePrivacy.ONLINE:PresencePrivacy.OFFLINE;h(za);n=za;}else if(zb.event=='online_policy_update'){f(z.online_policy);l=z.online_policy;}PresencePrivacy.inform('privacy-user-presence-response');}d().log('channel_message_received',{data:w.obj});});}return copy_properties(new Arbiter(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(y,w,x){if(k)return;k=true;v=n=y;i=l=w;j=copy_properties({},x);m=copy_properties({},x);q=false;this.inform('initialized',this,Arbiter.BEHAVIOR_PERSISTENT);this.inform('privacy-changed');this.inform('privacy-user-presence-changed');d().log('initialized',{visibility:y,policy:w});Arbiter.inform('chat-visibility/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('privacy_changed'),e.bind(this));Arbiter.subscribe(window.channel.ON_CONFIG,function(za,z){var zc=z.getConfig('visibility',null);if(zc!==null&&typeof(zc)!=='undefined'){var zb=zc?PresencePrivacy.ONLINE:PresencePrivacy.OFFLINE;h(zb);d().log('config_visibility',{vis:zb});}}.bind(this));Arbiter.subscribe('channel/visibility-config',function(z,za){var zb=za?PresencePrivacy.ONLINE:PresencePrivacy.OFFLINE;if(zb!=v){h(zb);d().log('config_visibility_old_channel',{vis:zb});}}.bind(this));},setVisibility:function(x){n=v;h(x);var w={visibility:x};t(c,w);d().log('set_visibility',{data:w});return x;},getVisibility:function(){return v;},setDefaultOnlinePolicy:function(x){l=i;f(x);var w={online_policy:x};t(b,w);d().log('set_online_policy',{data:w});return x;},getDefaultOnlinePolicy:function(){return i;},getFriendVisibility:function(w){return j[w]||PresencePrivacy.UNLISTED;},allows:function(w){if(this.getVisibility()===PresencePrivacy.OFFLINE)return false;var x=this.getDefaultOnlinePolicy();return x===PresencePrivacy.ONLINE_TO_WHITELIST?j[w]==PresencePrivacy.WHITELISTED:j[w]!=PresencePrivacy.BLACKLISTED;},setFriendVisibility:function(z,za){if(z.length>0){for(var x=0;x<z.length;x++){var y=z[x];m[y]=j[y];g(y,za);}var w={users:z,setting:za};t(a,w);d().log('set_friend_visibility',{data:w});}return za;},allow:function(w){var x=this.getDefaultOnlinePolicy()===PresencePrivacy.ONLINE_TO_WHITELIST?PresencePrivacy.WHITELISTED:PresencePrivacy.UNLISTED;return this.setFriendVisibility([w],x);},disallow:function(w){var x=this.getDefaultOnlinePolicy()===PresencePrivacy.ONLINE_TO_BLACKLIST?PresencePrivacy.BLACKLISTED:PresencePrivacy.UNLISTED;return this.setFriendVisibility([w],x);},getBlacklist:function(){var x=[];for(var w in j)if(j[w]===PresencePrivacy.BLACKLISTED)x.push(w);return x;},getWhitelist:function(){var x=[];for(var w in j)if(j[w]===PresencePrivacy.WHITELISTED)x.push(w);return x;},getMapForTest:function(){return j;},setMapForTest:function(w){j=w;}});})();
var AvailableList=window.AvailableList||(function(){var b=5;var e=60000;var f='/ajax/chat/buddy_list.php';var d=5000;var c=1800000;var a=.005;var zi=0;var zp=false;var za=0;var zh=false;var zf=null;var w=null;var m=null;var v=0;var u=0;var l=null;var zg={};var t=false;var zd={};var ze={};var z={};var n=null;var g=JSLogger.create('available_list');var x={'0':2,'1':1,'-1':0,'2':3};var zj={0:-1,1:1,2:0,3:2};function q(){return Chat.isOnline()?(zp?zf:w):null;}function h(zt,zr){var zs=null;switch(zt){case AvailableList.OFFLINE:zs='offline';break;case AvailableList.IDLE:zs='idle';break;case AvailableList.ACTIVE:zs='active';break;case AvailableList.MOBILE:zs='mobile';break;}g.rate(zs,zr);}function j(zr,zv,zs,zu){if(zr==Env.user)return;switch(zv){case AvailableList.OFFLINE:case AvailableList.IDLE:case AvailableList.ACTIVE:case AvailableList.MOBILE:break;default:return;}var zt=AvailableList.get(zr)!=zv;if(zs){zd[zr]=zv;ze[zr]=zu||(presence.getTime()+e);delete zg[zr];}else zg[zr]=zv;if(zt){zi++;if(!m)m=zk.defer();h(zv,zs);}}function y(zs,zt,zr){n({observer:presence.user,observee:zs,status:zt,latency:zr});}function zm(zr){l=zr;Arbiter.inform('buddylist/count-changed',zr);}function zn(zr){u=new Date();z=Object.from(zr);}function zl(zu){if(presence.isShutdown||!Chat.isOnline()){AvailableList._poller.stop();return;}v=new Date();var zs=false;if(new Date()-u>c)zs=true;zh=true;var zr=[];for(var zt in ChatUserInfos)zr.push(zt);zu.setHandler(zc).setErrorHandler(zb).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:Env.user,available_user_info_ids:zr,force_render:true,fetch_mobile:zs}).setURI(f).setAllowCrossPageTransition(true);}function zc(zr){require.ensure(['presence-cookie-manager'],function(zw){var zv=zr.getPayload();var zs=zv.buddy_list;if(!zs){zb(zr);return;}presence.updateServerTime(zv.time);AvailableList.updateTime=presence.getTime();za=0;zh=false;if(zs.forcedRender)AvailableList.haveFullList=true;if(zs.availableCount!=null)zm(zs.availableCount);if(zs.mobile_friends!=null)zn(zs.mobile_friends);var zy=zs.userInfos;if(zy)for(var zt in zy)setUserInfo(zt,zy[zt]);var zu=zs.nowAvailableList;var zz=zs.wasAvailableIDs;for(var zx in zg)if(AvailableList.get(zx)!==AvailableList.OFFLINE)zz.push(zx);if(zz){zz.forEach(function(zza){if(!(zu&&(zza in zu))&&(zg[zza]!=AvailableList.OFFLINE)&&((zza in zd)&&(zd[zza]==AvailableList.OFFLINE)))y(zza,AvailableList.OFFLINE,presence.getTime()+e-ze[zza]);zg[zza]=AvailableList.OFFLINE;});zk.defer();}t=zs.userIsIdle;zu&&AvailableList.addLegacyAvailableList(zu);if(zs.newAvailableList){AvailableList.presenceData=zs.newAvailableList;AvailableList.haveFullList=true;}zq();zw.store();});}function zb(zr){if(presence.checkMaintenanceError(zr))return;za++;zh=false;if(za>=b){zm(0);Arbiter.inform('buddylist/update-error');}}function p(){var zr={};AvailableList.getAvailableIDs().forEach(function(zs){zr[zs]={i:AvailableList.isIdle(zs)?1:0};});return zr;}function zq(){if(AvailableList.haveFullList)Arbiter.inform('buddylist/updated');}function zk(){m=null;if(AvailableList.haveFullList)zm(AvailableList.getAvailableIDs().length);Arbiter.inform('buddylist/availability-changed');}function k(zr,zt){for(var zs in zr){var zv;var zu;if(zt){zv=x[zr[zs].ol];zu=zr[zs].exp;}else if(!zr[zs]){zv=AvailableList.OFFLINE;}else if(zr[zs].i){zv=AvailableList.IDLE;}else if(zr[zs].m){zv=AvailableList.MOBILE;}else zv=AvailableList.ACTIVE;j(zs,zv,zt,zu);}}function s(){zo();if(Chat.isOnline()){AvailableList.update();}else i();}function i(){AvailableList.haveFullList=false;v=0;u=0;l=null;zg={};zd={};ze={};z={};zi++;zk();}function zo(){AvailableList._poller&&AvailableList._poller.setTimePeriod(q());}function o(){var zr={};var zs=AvailableList.getLegacyOverlay();if(!is_empty(zs))zr.uo=zs;return zr;}function r(zs,zr){require.ensure(['ChatConfig'],function(zt){zr.chat_config=zt.getDebugInfo();zr.available_list_debug_info={};AvailableList.getAvailableIDs().forEach(function(zu){zr.available_list_debug_info[zu]=AvailableList.getDebugInfo(zu);});});}return {OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,haveFullList:false,init:function(zy,zt,zx,zw,zu,zr,zs,zv){require.ensure(['ChatConfig','PresenceInitialData'],function(zz,zza){this._chatConfig=zz;n=EagleEye.createLogger('presence-status',zza.sitevars.BUDDY_STATUS_LOG_FRAC||a);AvailableList.updateTime=zy;AvailableList.haveFullList=zt;if(zt&&zv)zn(zv);k(zx,true);AvailableList.addLegacyAvailableList(zr);zf=zw;w=zu;AvailableList._poller=new Poller(q(),zl,true);Arbiter.subscribe('chat-visibility/initialized',function(zzb){g.log('visibility_init',zzb);zo();});zm(zs);Arbiter.subscribe(JSLogger.DUMP_EVENT,r);Arbiter.subscribe('presence/restarted',AvailableList.update);Arbiter.subscribe('presence-cookie-manager/initialized',function(zzb,zzc){zzc.register('bl',o);});if(zz.get('blackbird')){PresencePrivacy.subscribe('privacy-changed',zk);PresencePrivacy.subscribe('privacy-availability-changed',function(zzc,zzb){for(var zzd in zzb.user_availabilities)this.set(zzd,zzb.user_availabilities[zzd]);}.bind(this));PresencePrivacy.subscribe('privacy-user-presence-response',AvailableList.update);}else Arbiter.subscribe('chat/visibility-changed',s);if(AvailableList.haveFullList){v=new Date();}else if(zp)AvailableList.update();Arbiter.inform('available-list/initialized',AvailableList,Arbiter.BEHAVIOR_PERSISTENT);}.bind(this));},get:function(zr){if(zr==Env.user)return AvailableList.ACTIVE;var zs=AvailableList.OFFLINE;if(zr in zd&&(presence.getTime()<ze[zr]||!(zr in zg))){zs=zd[zr];}else if(zr in zg)zs=zg[zr];if(this._chatConfig&&this._chatConfig.get('blackbird')&&!PresencePrivacy.allows(zr))zs=AvailableList.OFFLINE;if(zs==AvailableList.OFFLINE)if(z[zr])zs=AvailableList.MOBILE;return zs;},isUserIdle:function(){return t;},isReady:function(){return AvailableList.haveFullList;},set:function(zr,zs){j(zr,zs,true);window.presence&&presence.doSync();},update:function(){if(new Date()-v<d){!zh&&zq.defer();return;}zp=true;zo();AvailableList._poller&&AvailableList._poller.requestNow();},getRev:function(){return zi;},isIdle:function(zr){return AvailableList.get(zr)==AvailableList.IDLE;},getCount:function(){return l;},getAvailableIDs:function(){var zr,zs=[];for(zr in zg)if(AvailableList.get(zr)!==AvailableList.OFFLINE)zs.push(zr);for(zr in zd){if(zr in zg)continue;if(AvailableList.get(zr)!==AvailableList.OFFLINE)zs.push(zr);}for(zr in z){if(zr in zg||zr in zd)continue;zs.push(zr);}return zs;},getLegacyOverlay:function(){var zs={};for(var zr in zd)if(ze[zr]>presence.getTime())zs[zr]={exp:ze[zr],ol:zj[zd[zr]]};return zs;},addLegacyOverlay:function(zr){k(zr,true);window.presence&&presence.doSync();},addLegacyAvailableList:function(zr){k(zr,false);},getDebugInfo:function(zr){var zs;if(ChatUserInfos[zr])zs=ChatUserInfos[zr].name;return {id:zr,presence:zg[zr],overlay:zd[zr],overlayTime:ze[zr],mobile:z[zr],name:zs};}};})();
if(!window.Chat){var Chat={openTab:function(a,b,d,c){if(window.External&&External.Chat&&External.Chat.openWindow)External.Chat.openWindow(a);this._trackOpenTabClick(a,c);Chat._withComponent('chatDisplay',function(e){e.focusTab(a,true,b,b,d);});},_trackOpenTabClick:function(b,c){if(c&&c=='ordered_list'||c=='more_online_friends'||c=='online_friends'||c=='typeahead'){var a={target:b,source:c};new AsyncSignal('/ajax/chat/ct.php',a).send();}},openMultichatTab:function(d,b,a,e,f,c){Chat._withComponent('chatDisplay',function(g){g.createMultichatTab(d,b,a,e,f,true,c);});},loadTabFragile:function(b,c,a,d){require.ensure(['ChatConfig'],function(e){if(e.get('mercury_integration')){require.ensure(['ChatController'],function(f){f.raiseFragileGroupTab(b);});}else Chat._withComponent('chatDisplay',function(f){f.loadTabFragile(b,c,a,d);});});},openBuddyList:function(){Chat._withComponent('buddyListNub',function(a){a.show();});},closeBuddyList:function(){Chat._withComponent('buddyListNub',function(a){a.hide();});},toggleSidebar:function(){Chat._withComponent('sidebar',function(a){a.toggle();});},goOnline:function(a){require.ensure(['ChatConfig'],function(b){if(b.get('blackbird')){PresencePrivacy.subscribe('initialized',function(){if(PresencePrivacy.getVisibility()===PresencePrivacy.OFFLINE){Chat.getLogger('blackbird').log('chat_go_online');PresencePrivacy.setVisibility(PresencePrivacy.ONLINE);}a&&a();});return;}Arbiter.subscribe('chat-options/initialized',function(event,c){if(Chat.isOnline()){a&&a();}else{if(a)var d=Arbiter.subscribe('chat/visibility-changed',function(){Arbiter.unsubscribe(d);a();});c.sendVisibility(true);}});});},isOnline:function(){var a=null;require.ensure(['ChatConfig'],function(b){a=b;});if(a){if(a.get('blackbird'))return PresencePrivacy&&PresencePrivacy.getVisibility()===PresencePrivacy.ONLINE;return window.chatOptions&&chatOptions.visibility;}return false;},squelchTab:function(a,b){Chat._withComponent('chatDisplay',function(c){c.setSquelchedTab(a,true);c.closeTab(a);});},unsquelchTab:function(a){Chat._withComponent('chatDisplay',function(b){b.setSquelchedTab(a,false);});},getActiveChats:function(){if(!window.chatDisplay)return [];return keys(chatDisplay.tabs);},hasFocusedChat:function(){return chatDisplay.hasFocusedTab();},getActiveFriendChats:function(){var a=this.getActiveChats();return a.filter(function(b){return chatDisplay.tabs[b]&&chatDisplay.tabs[b].getPostType()=='friend';});},getLogger:function(a){var b=window.channel_manager||window.channelManager;if(b&&b.getLogger)return b.getLogger(a);return JSLogger.create(a);},_componentInitEvents:{chatDisplay:'chat-display/loaded',buddyListDisplay:'buddylist-display/initialized',buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'},_withComponent:function(b,a){Arbiter.subscribe(Chat._componentInitEvents[b],function(event,c){a(c);});}};copy_properties(Chat,{updateUserInfo:bagofholding,setUserInfo:bagofholding});}
(function(){window.ChannelManager=function(b,e,d,a,c){this.user=e;this.iframeLoadMaxRetries=1;this.iframeLoadMaxSubdomain=6;this.expectResponseTimeout=5000;this.retryInterval=d;this.channelConfig=a;this._init(b,c);Arbiter.subscribe(JSLogger.DUMP_EVENT,function(event,f){f.transportVersion=1;});};ChannelManager.CONN_LOG_INTERVAL=10000;ChannelManager.prototype={_init:function(c,e){this.channelManagerId=rand32();this.config={};this.channel={};this.isActionRequest=true;this.isReady=false;this.isRebuilding=false;this.iframeIsLoaded=false;this.iframeEverLoaded=false;this.iframeCheckFailedCount=0;this.shouldClearSubdomain=false;this.subframe=c;Event.listen(this.subframe,'load',this._iframeLoadCheck.bind(this));this.postMessage=null;var a=presenceCookieManager.getSubCookie('ch');if(e){this.iframeSubdomain=null;}else{this.iframeSubdomain=0;if(a&&a.sub){for(var b=0;b<a.sub.length;b++)if(!a.sub[b]){this.iframeSubdomain=b;break;}if(b==a.sub.length)if(b==this.iframeLoadMaxSubdomain&&URI().isSecure()){this.iframeSubdomain=null;this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadMaxSubdomain);}else this.iframeSubdomain=a.sub.length;}}this.handleIframeEvent=CrossDocument.mkEventHandler(this._handleIframeMessage.bind(this));this.handleIframeMessage=CrossDocument.mkMessageHandler(this._handleIframeMessage.bind(this));CrossDocument.setListener(this.handleIframeEvent.bind(this));presenceCookieManager.register('ch',this._getCookieInfo.bind(this));if(typeof window.onpageshow!='undefined'){Event.listen(window,'pagehide',this._onUnload.bind(this));Event.listen(window,'pageshow',this.rebuild.bind(this,ChannelRebuildReasons.Refresh));}else onunloadRegister(this._onUnload.bind(this));this._connLogger=EagleEye.createLogger('channel-connectivity',this.getConfig('CONNECTIVITY_SAMPLING',.01));this._connTime=Env.start;this._connT=2000;this._connectivity={};(this._connSample=this._connSample.bind(this))();(this._connLog=this._connLog.bind(this))();var d=0;UserActivity.subscribe(function(){if(new Date()-d>3000){d=new Date();this.setActionRequest(true);}}.bind(this));},_connSample:function(){var a=new Date(),b=this._connState||'idle';var c=a-this._connTime;this._connAdd(b,c);this._connTime=a;setTimeout(this._connSample,1000*(1+Math.random()),false);},_connAdd:function(a,b){this._connectivity[a]=(this._connectivity[a]||0)+b;},_connLog:function(){this._connLogger(this._connectivity);this._connectivity={};this._connT=Math.min(60000,2*this._connT);setTimeout(this._connLog,this._connT,false);},sendIframeMessage:function(b){if(!this.postMessage)return;var c=JSON.stringify(b);try{this.postMessage(c,this.targetOrigin);}catch(a){this.getLogger().error('iframe_msg_error',a);}},_handleIframeMessage:function(h){var g=this.channel.currentSeq;var c={old_seq:g};if('seq' in h){c.new_seq=h.seq;c.seq_gap=h.seq-g;this.channel.currentSeq=h.seq;presence.doSync();}switch(h.t){case 'init':this._connState=null;this.iframeLoaded();break;case 'log':break;case 'reconnect':if(window.loaded){this.getLogger().error('refresh_'+h.reason);this.rebuild(h.reason);this.channel.shutdownHandler(true);}break;case 'connectivity':delete h.t;if('state' in h){this._connState=h.state;delete h.state;}for(var f in h)this._connAdd(f,h[f]);break;case 'fullReload':this.getLogger().error('full_reload',c);presenceCookieManager.clear();Arbiter.inform('channel/invalid_history');break;case 'msg':var a=this.channel;if(h.msgs){var i=h.msgs;var j=0;for(var e=0;e<i.length;e++)if(i[e].seq!==-1)j++;var k=a.currentSeq-j;for(var e=0;e<i.length;e++){if(k>=g){var b=i[e].msg;try{a.msgHandler(a.name,b);}catch(d){this.getLogger().error('msg_handling_error',d);}}if(i[e].seq!==-1)k++;}}else{var i=h.ms;var k=a.currentSeq-i.length;for(var e=0;e<i.length;e++,k++)if(k>=g){var b=i[e];try{a.msgHandler(a.name,b);}catch(d){this.getLogger().error('msg_handling_error',d);}}}break;default:this.getLogger().error('unknown_msg_type',{type:h.t});presence.permaShutdown();this.stop();break;}},_onUnload:function(){this.shouldClearSubdomain=true;presence.doSync(true);},addChannel:function(a,d,b,f,e,c){if(this.channel.name){this.getLogger().error('addchannel_called_twice');return;}this.channel={name:a,currentSeq:d,msgHandler:b,startHandler:f,shutdownHandler:e,restartHandler:c};presence.doSync();},_getCookieInfo:function(){var b={};if(this.config.host){b.h=this.config.host;if(this.config.port)b.p=this.config.port;if(null!==this.iframeSubdomain){var a=presenceCookieManager.getSubCookie('ch');var e=(a&&a.sub)?a.sub:[];var d=e.length;if(this.shouldClearSubdomain){e[this.iframeSubdomain]=0;}else{e[this.iframeSubdomain]=1;for(var c=d;c<=this.iframeSubdomain;c++)if(!e[c])e[c]=0;}b.sub=e;}b[this.channel.name]=this.channel.currentSeq;}b.ri=this.retryInterval;return b;},getConfig:function(c,b){var a=this.channelConfig;return a&&(c in a)?a[c]:b;},stop:function(){this.stopped=true;this.setReady(false);},setReady:function(a){this.isReady=a;var b={type:'isReady',isReady:a,isActionRequest:this.isActionRequest};if(a&&this.isActionRequest)this.isActionRequest=false;if(a){b.channelName=this.channel.name;b.currentSeq=this.channel.currentSeq;b.channelManagerId=this.channelManagerId;b.channelConfig=this.channelConfig;}this.sendIframeMessage(b);},setActionRequest:function(a){this.sendIframeMessage({type:'isActionRequest',isActionRequest:a});},expectResponse:function(){this.sendIframeMessage({type:'expectResponse',newTimeout:this.expectResponseTimeout});},_iframeUrl:function(a,c,b){var d;if(null===this.iframeSubdomain){d='';}else{d=this.iframeSubdomain;d+=URI().isSecure()?'-':'.';}return new URI().setDomain(d+a+'.facebook.com').setPort(c).setPath(b).setSecure(URI().isSecure()).toString();},iframeGetJS:function(){this.getLogger().log('iframe_resources');return this.config.resources;},getLogger:function(a){a=a||'channel0';return JSLogger.create(a);},iframeLoad:function(a,c){this.isReady=c;this.iframeIsLoaded=false;this.config=a;var e=this._iframeUrl(a.host,a.port,a.path);clearTimeout(this._checkTimer);this._checkTimer=this._iframeCheck.bind(this).defer(this.getConfig('IFRAME_LOAD_TIMEOUT',30000),false);var d=null;window.onchanneliframeready=this.iframeGetJS.bind(this);if(!ua.ie()||ua.ie()<8)try{d=this.subframe.contentDocument;}catch(b){}if(d){try{d.location.replace(e);}catch(b){this.getLogger().error('error_setting_location',b);}}else if(this.subframe.contentWindow){this.subframe.src=e;}else if(this.subframe.document){this.subframe.src=e;}else this.getLogger().error('error_setting_subframe_url');this.getLogger().debug('iframe_location',{url:e});},_iframeLoadCheck:function(){try{this.subframe.contentWindow.document.body.innerHTML;}catch(a){this.getLogger().error('iframe_load_check_error',{count:this.iframeCheckFailedCount,error:a.toString()});}},iframeLoaded:function(){if(!this.iframeIsLoaded){this.iframeIsLoaded=true;this.postMessage=CrossDocument.mkPostMessage(this.subframe.contentWindow,this.subframe.contentDocument,this.subframe.contentWindow.channelUplink.handleParentMessage);this.targetOrigin='*';this.setReady(this.isReady);if(this.iframeCheckFailedCount){this.channel.restartHandler(false);this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadRetryWorked);}else this.channel.startHandler();this.iframeCheckFailedCount=0;this.iframeEverLoaded=true;}},_iframeCheck:function(){delete this._checkTimer;if(!this.iframeIsLoaded){this.iframeCheckFailedCount++;var a=this.config;this.config={};presenceCookieManager.store();if(this.iframeCheckFailedCount<=this.iframeLoadMaxRetries){this.rebuild(ChannelRebuildReasons.IFrameLoadRetry);}else{this.channel.shutdownHandler();this._sendDummyReconnect(ChannelRebuildReasons.IFrameLoadGiveUp);}}else this.retryInterval=0;},_sendDummyReconnect:function(b){var a=new AsyncRequest().setURI('/ajax/presence/reconnect.php').setData({reason:b,iframe_loaded:this.iframeEverLoaded}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);a.specifiesWriteRequiredParams()&&a.send();},_rebuildResponse:function(c){var b=c.getPayload();if(!b.user_channel){this.getLogger().error('invalid_channel_name',{name:this.channel.name});presence.permaShutdown();this.stop();return;}var a=b.user_channel;this.getLogger().debug('rebuild_response',{channel:a,seq:b.seq,host:b.host,port:b.port});this.channel.currentSeq=b.seq;this.isRebuilding=false;if(b.path!=this.config.path||b.host!=this.config.host){this.iframeLoad(b,true);}else this.setReady(true);presenceCookieManager.store();Arbiter.inform('channel/visibility-config',b.visibility);this.channel.restartHandler(true);},_retryRebuild:function(c,a){var d=this.getConfig('MAX_RETRY_INTERVAL',60000);var e=this.getConfig('MIN_RETRY_INTERVAL',10000);if(a){this.retryInterval=d;}else if(this.retryInterval==0){this.retryInterval=e;}else this.retryInterval=Math.min(d,this.retryInterval*2);var b=this.retryInterval*(.75+Math.random()*.5)|0;this.getLogger().warn('manager_retrying',{delay:b});setTimeout(this._rebuildSend.bind(this,c),this.retryInterval,false);},_rebuildError:function(a,b){this.channel.shutdownHandler(true);this.getLogger().error('rebuild_error',{error:b.getErrorDescription()});if(presence.checkMaintenanceError(b)){this.getLogger().warn('mgr_maint_check_giveup');}else if(presence.checkLoginError(b)){if(presence.inPopoutWindow){this._retryRebuild(ChannelRebuildReasons.PrevFailed,true);}else this.getLogger().warn('mgr_login_check_giveup');}else this._retryRebuild(ChannelRebuildReasons.PrevFailed,false);},_rebuildTransportError:function(a,b){this.channel.shutdownHandler(true);this.getLogger().error('rebuild_transport_error',{error:b.getErrorDescription()});this._retryRebuild(a,false);},_rebuildSend:function(b){if(!presence.hasUserCookie(true))return;if(typeof b!='number')b=ChannelRebuildReasons.Unknown;this.getLogger().debug('sending_rebuild');var a=new AsyncRequest().setURI('/ajax/presence/reconnect.php').setData({reason:b,iframe_loaded:this.iframeEverLoaded}).setHandler(this._rebuildResponse.bind(this)).setErrorHandler(this._rebuildError.bind(this,b)).setTransportErrorHandler(this._rebuildTransportError.bind(this,b)).setOption('suppressErrorAlerts',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);return a.specifiesWriteRequiredParams()&&a.send();},rebuild:function(a){if(this.stopped)return;if(this.isRebuilding){this.getLogger().debug('already_rebuilding');return;}this.setReady(false);this.isRebuilding=true;this.getLogger().debug('rebuilding');if(a==ChannelRebuildReasons.RefreshDelay)this.retryInterval=this.channelConfig.MAX_RETRY_INTERVAL;setTimeout(this._rebuildSend.bind(this,a),this.retryInterval,false);}};}());
function TinyPresence(g,c,b,a,e,d,f){this.user=g;this.name=c;this.firstName=b;this.alias=a;this.sitevars=f;this.updateServerTime(e);this.pageLoadTime=this.getTime();require.ensure(['presence-cookie-manager'],function(h){this._presenceCookieManager=h;this._init(d);}.bind(this));}TinyPresence.prototype={cookiePollTime:2000,shutdownDelay:5000,restartDelay:3000,_init:function(a){this.stateStorers=[];this.stateLoaders=[];this._syncTimeout=null;this.cookiePoller=null;this.heartbeat=null;this.stateUpdateTime=0;this.loaded=false;this.isShutdown=false;this.isShuttingDown=false;this.isRestarting=false;this.isPermaShutdown=false;this.shutdownTime=0;this.syncPaused=0;this._presenceCookieManager.register('state',this._getCookieData.bind(this));Arbiter.subscribe("page_transition",this.checkRebuild.bind(this));this.load();},init:function(){require.ensure(['PresenceUtil'],function(a){this.windowID=a.getSessionID();var c={ON_CONNECT:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});this.restart();},ON_SHUTDOWN:function(e,d){switch(e){case channel.HINT_AUTH:return this.loginShutdown();case channel.HINT_CONN:return this.connectionShutdown();case channel.HINT_MAINT:return this.maintenanceShutdown();default:return this.permaShutdown();}}};for(var b in c)Arbiter.subscribe(channel[b],c[b].bind(this));}.bind(this));},getWindowID:function(){return this.windowID;},updateServerTime:function(a){this.timeSkew=Date.now()-a;},getTime:function(){return Date.now()-this.timeSkew;},debug:function(a){},warn:function(a){this.logError("13003:warning:"+a);},error:function(a){this.logError("13002:error:"+a);},logError:function(a){window.EagleEye&&EagleEye.log('realtime-error',{data:a});},load:function(){var b=this._presenceCookieManager.getSubCookie('state');if(!b){this.debug('presence: got null state cookie, loading with current state');this._load(this._getCookieData());return;}try{this._load(b);}catch(a){this.error('presence: got load exception: '+a.toString());this._load(this._getCookieData());}},_load:function(b){this.syncPaused++;this.stateUpdateTime=verifyNumber(b.ut);if(!this.cookiePoller)this.cookiePoller=setInterval(this._pollCookie.bind(this),this.cookiePollTime);this.state=b;for(var a=0;a<this.stateLoaders.length;a++)this.stateLoaders[a](b);this.syncPaused--;this._loaded();},_loaded:function(){this.loaded=true;},_pollCookie:function(){var a=this._presenceCookieManager.getSubCookie('state');if(!a)return;if(a.ut>this.stateUpdateTime){this.load(a);return;}},_getCookieData:function(){var b={ut:this.stateUpdateTime};for(var a=0;a<this.stateStorers.length;a++)b=this.stateStorers[a](b);this.state=b;return this.state;},doSync:function(a){if(this.syncPaused)return;if(a){this._doSync();}else if(!this._syncTimeout)this._syncTimeout=this._doSync.bind(this).defer();},_doSync:function(){clearTimeout(this._syncTimeout);this._syncTimeout=null;this.stateUpdateTime=Date.now();this._presenceCookieManager.store();this._load(this.state);},pauseSync:function(){this.syncPaused++;},resumeSync:function(){this.syncPaused--;this.doSync();},handleMsg:function(a,b){this._handleMsg.bind(this,a,b).defer();},_handleMsg:function(a,b){if(typeof b=='string'){if(b=='shutdown'){this.connectionShutdown();}else if(b=='restart')if(this.isShutdown)this.restart();return;}if(this.isShutdown)return false;if(!b.type)return;Arbiter.inform(PresenceMessage.getArbiterMessageType(b.type),{sender:this,channel:a,obj:b});},checkRebuild:function(){if(!window.channel_manager)if(this.isShutdown&&!this.isPermaShutdown)channelManager.rebuild(ChannelRebuildReasons.PageTransitionRetry);},getErrorDescription:function(a){var c=a.getError();var b=a.getErrorDescription();if(!b)b="Une erreur s'est produite.";if(c==1357001)b="Votre session a expir\u00e9. Veuillez vous reconnecter.";return b;},checkLoginError:function(a){var b=a.getError();if(b==1357001||b==1357004||b==1348009){this.loginShutdown();return true;}return false;},checkMaintenanceError:function(a){if(a.getError()==1356007){this.maintenanceShutdown();return true;}return false;},permaShutdown:function(){this.isPermaShutdown=true;var a=_tx("{Chat} de Facebook conna\u00eet quelques probl\u00e8mes techniques.",{Chat:"Discussion instantan\u00e9e"});this.shutdown(false,a,"perma_shutdown");},loginShutdown:function(){var a="Votre session a expir\u00e9. Veuillez vous reconnecter.";this.shutdown(false,a,"login_shutdown");},connectionShutdown:function(b){var a=_tx("Connexion au {Chat} de Facebook impossible.",{Chat:"Discussion instantan\u00e9e"});this.shutdown(b,a,"connection_shutdown");},maintenanceShutdown:function(){var a=_tx("{Chat} de Facebook est en phase de maintenance.",{Chat:"Discussion instantan\u00e9e"});this.shutdown(false,a,"maintenance_shutdown");channelManager.stop();},versionShutdown:function(){var a=_tx("Actualisez cette page pour acc\u00e9der \u00e0 la version la plus r\u00e9cente de {Chat} Facebook.",{Chat:"Discussion instantan\u00e9e"});this.shutdown(false,a,"version_shutdown");channelManager.stop();},shutdown:function(d,c,a){this.isRestarting=false;this.isShuttingDown=true;var b=Date.now();this.shutdownTime=b;if(!d){this._shutdown(c,0,a);}else setTimeout(this._shutdown.bind(this,c,b,a),this.shutdownDelay,false);},_shutdown:function(b,c,a){if(!this.isShuttingDown&&c==this.shutdownTime)return;if(c&&this.isShutdown)return;if(typeof b!='string'||!b)b=_tx("{Chat} de Facebook conna\u00eet quelques probl\u00e8mes techniques.",{Chat:"Discussion instantan\u00e9e"});if(typeof a!='string'||!a)a="undefined";this.warn("presence:displaying_shutdown:"+a);if(this.isShutdown)return;this.logError("13001:shutdown:presence:"+a);this.isShutdown=true;Arbiter.inform(PresenceMessage.SHUTDOWN,{sender:this,reason:b});},restart:function(a){this.isShuttingDown=false;this.isRestarting=true;if(!a){this._restart(0);}else this._restart.bind(this,this.shutdownTime).defer(this.restartDelay,false);},_restart:function(a){if(!this.isRestarting||(a&&a!=this.shutdownTime))return;this.debug("presence: restarting");this.isShutdown=false;this.load();Arbiter.inform(PresenceMessage.RESTARTED,{sender:this});},start:function(){Arbiter.inform(PresenceMessage.STARTED,{sender:this});},registerStateStorer:function(a){this.stateStorers.push(a);},registerStateLoader:function(a){this.stateLoaders.push(a);},hasUserCookie:function(a){var b=this.user==getCookie('c_user');if(!b&&a)this.permaShutdown();return b;}};
function Presence(g,c,b,a,e,d,f){this.parent.construct(this,g,c,b,a,e,d,f);}Class.extend(Presence,'TinyPresence');Presence.prototype={_init:function(c){try{this.holder=$('fbDockChat');}catch(a){}this.parent._init(c);var d=ua.safari();this.isSafari2=(d&&d<500);var b=ua.firefox();this.isFF2=(b&&b<3);this.isWindows=ua.windows();define('presence',[],this);},_load:function(a){this.parent._load(a);this.parent._loaded();},_loaded:bagofholding,renderLink:function(b,c,a){return '<a href="'+b+'"'+(a?a:'')+'>'+c+'</a>';},_shutdown:function(c,d,b){this.parent._shutdown(c,d,b);if((!this.isShuttingDown&&d===this.shutdownTime)||(d&&this.isShutdown))return;if(Chat.isOnline())CSS.addClass(this.holder,'presence_error');try{var errorNub=$('fbChatErrorNub');TooltipLink.setTooltipText(DOM.find(errorNub,'a.fbNubButton'),c);}catch(a){}},_restart:function(a){this.parent._restart(a);if(!this.isRestarting||(a&&a!=this.shutdownTime))return;CSS.removeClass(this.holder,'presence_error');},isOnline:function(){return Chat.isOnline();}};
function LiveMessageReceiver(a){this.eventName=a;this.subs=null;this.handler=bagofholding;this.shutdownHandler=null;this.restartHandler=null;this.registered=false;this.appId=1;}LiveMessageReceiver.prototype.setAppId=function(a){this.appId=a;return this;};LiveMessageReceiver.prototype.setHandler=function(a){this.handler=a;this._dirty();return this;};LiveMessageReceiver.prototype.setRestartHandler=function(a){this.restartHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype.setShutdownHandler=function(a){this.shutdownHandler=a.shield();this._dirty();return this;};LiveMessageReceiver.prototype._dirty=function(){if(this.registered){this.unregister();this.register();}};LiveMessageReceiver.prototype.register=function(){var b=function(d,c){return this.handler(c);}.bind(this);var a=PresenceMessage.getAppMessageType(this.appId,this.eventName);this.subs={};this.subs.main=Arbiter.subscribe(a,b);if(this.shutdownHandler)this.subs.shut=Arbiter.subscribe(channel.ON_SHUTDOWN,this.shutdownHandler);if(this.restartHandler)this.subs.restart=Arbiter.subscribe(PresenceMessage.RESTARTED,this.restartHandler);this.registered=true;return this;};LiveMessageReceiver.prototype.unregister=function(){if(!this.subs)return this;for(var a in this.subs)if(this.subs[a])Arbiter.unsubscribe(this.subs[a]);this.subs=null;this.registered=false;return this;};LiveMessageReceiver.route=function(b){var a=function(c){var d=PresenceMessage.getAppMessageType(b.app_id,b.event_name);Arbiter.inform(d,c,Arbiter.BEHAVIOR_PERSISTENT);};if(b.hasCapture){new AsyncRequest().setHandler(function(c){a(c.getPayload());}).setAllowCrossPageTransition(true).handleResponse(b.response);}else a(b.response);};var init_live_message_receive=window.init_live_message_receive||function(){init_live_message_receive=bagofholding;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('app_msg'),function(a,b){if(b.obj.event_name=='beep_event'){Bootloader.loadComponents('beeper',function(){Beeper.ensureInitialized();LiveMessageReceiver.route(b.obj);});}else LiveMessageReceiver.route(b.obj);});};
function PresenceIndicator(){}PresenceIndicator.prototype={init:function(b,a,d){this._id=b;this._firstname=a;this._tooltip=d;this._image=DOM.scry(this._tooltip,'i')[0];this._previousAvail=null;this._jslog=JSLogger.create('presence_indicator');Arbiter.subscribe('chat-visibility/initialized',function(e){this._jslog.log('vis_init',e);this._updateVisibility();}.bind(this));this._subscriptions=[Arbiter.subscribe(['available-list/initialized','buddylist/availability-changed'],this._updateAvailability.bind(this)),Arbiter.subscribe(['chat/visibility-changed'],this._updateVisibility.bind(this))];var c=Event.listen(this._tooltip,'click',function(){if(this._previousAvail!=AvailableList.OFFLINE)Chat.openTab(this._id);}.bind(this));onleaveRegister(function(){c.remove();while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());}.bind(this));},_updateAvailability:function(){require.ensure(['ChatConfig'],function(a){if(!AvailableList.isReady())return;var d;var c;var b=AvailableList.get(this._id);if(b===this._previousAvail)return;this._previousAvail=b;switch(b){case AvailableList.OFFLINE:d=a.get('blackbird')?_tx("{name} est hors ligne.",{name:this._firstname}):_tx("{name} est indisponible.",{name:this._firstname});c='offline';break;case AvailableList.IDLE:d=_tx("{name} est inactif.",{name:this._firstname});c='idle';break;case AvailableList.ACTIVE:d=a.get('blackbird')?_tx("{name} est en ligne.",{name:this._firstname}):_tx("{name} est disponible.",{name:this._firstname});c='online';break;case AvailableList.MOBILE:d=_tx("{name} est disponible sur son mobile.",{name:this._firstname});c='mobile';break;default:throw new Error('Invalid availability');}TooltipLink.setTooltipText(this._tooltip,d);CSS.setClass(this._image,c);}.bind(this));},_updateVisibility:function(){if(Chat.isOnline()){CSS.show(this._tooltip);}else CSS.hide(this._tooltip);}};
function VideoEvents(){}Function.mixin(VideoEvents,'Arbiter',{ACTIVATING:'videochat/activating',LOGGING_IN:'videochat/logging_in',GETTING_TOKEN:'videochat/getting_token',CONNECTING:'videochat/connecting',SLOW_CONDITIONS:'videochat/slow_conditions',CALL_INCOMING:'videochat/call_incoming',CALL_CONNECTED:'videochat/call_connected',GOT_CALLEE:'videochat/got_callee',CALL_HANDLED:'videochat/call_handled',CALLEE_ANSWERING:'videochat/callee_answering',FATAL_ERROR:'videochat/fatal_error',CALL_IN_PROGRESS:'videochat/call_in_progress',NOT_AVAILABLE:'videochat/not_available',SERVER_ERROR:'videochat/server_error',ACTIVATE_FAILED:'videochat/activate_failed',ACTIVATE_TIMED_OUT:'videochat/activate_failed_time',WRONG_VERSION_ERROR:'videochat/wrong_version',FATAL_PLUGIN_ERROR:'videochat/plugin_fatality',SILENT_PLUGIN_ERROR:'videochat/plugin_silent_fatality',START_CALL_UI:'videochat/start_call_ui',START_CALL:'videochat/start_call',ANSWER_CALL:'videochat/answer_call',IGNORE_CALL:'videochat/ignore_call',CANCEL_CALL:'videochat/cancel_call',INSTALL_COMPLETED:'videochat/install_completed',log:function(a){window.console&&console.log&&console.log(a);},warn:function(a){window.console&&console.warn&&console.warn(a);},error:function(a){window.console&&console.error&&console.error(a);}});
var VideoChatPlugin=function(){};Function.mixin(VideoChatPlugin,'Arbiter',{INSTALL_TYPES:{JAVA:0,MANUAL:1},isSupported:function(){var b=ua.windows()&&((ua.ie()>=7&&!ua.ie64())||ua.firefox()>=3.6||ua.chrome()>=5);var a=(ua.osx()>10.4)&&(ua.firefox()>=3.6||ua.chrome()>=5||ua.safari()>=500);return (b||a);},notifyFromApplet:function(b,a){Arbiter.inform(String(b),{args:String(a)});},isInstalled:function(){var a=false;if(VideoChatPlugin.isSupported())if(VideoChatPlugin.usesActiveX()){var c=null;try{c=new ActiveXObject('SkypeLimited.SkypeWebPlugin');a=!!c;}catch(b){}c=null;}else a=VideoChatPlugin._getInstalledVersion();return a;},usesActiveX:function(){return ua.ie()&&ua.windows()&&!ua.opera();},setLogger:function(a){VideoChatPlugin.log=a||bagofholding;},embed:function(a){Bootloader.loadComponents('VideoChatPluginCore',function(){VideoChatPlugin.embed(a);});},remove:bagofholding,_getInstalledVersion:function(){if(!navigator)return null;navigator.plugins.refresh(false);mimeHandler=navigator.mimeTypes['application/skypesdk-plugin'];return mimeHandler&&mimeHandler.enabledPlugin;}});
var VideoChatView={RINGTONE_PATH:'/sound/bling.mp3',WINDOW_NAME_COOKIE_KEY:'vcpwn',TARGET_ID_COOKIE_KEY:'vctid',inIncomingCall:false,inOutgoingCall:false,inManualInstall:false,tokens:[],init:function(){VideoChatView.subscribe(VideoEvents.CALL_INCOMING,VideoChatView._onIncomingCall);VideoChatView.subscribe(VideoEvents.START_CALL_UI,function(a,b){if(!VideoChatView.inOutgoingCall){VideoChatView.inOutgoingCall=true;if(VideoChatPlugin.isInstalled()){VideoChatView.onOutgoingCall(b.idTarget);}else VideoChatView._invokeCore('promptInstall',b.idTarget);}});if(VideoChatPlugin.isSupported())CSS.addClass(document.documentElement,'videoCallEnabled');onbeforeunloadRegister(function(){if((VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall)&&!VideoChatView.inManualInstall)return "Quitter cette page mettra fin \u00e0 votre appel.";});onleaveRegister(function(){if(VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall){VideoEvents.inform(VideoEvents.CANCEL_CALL,{cause:'leave:page'});VideoChatView.inIncomingCall=false;VideoChatView.inOutgoingCall=false;}});VideoChatView._checkPriorState();},subscribe:function(b,a){VideoChatView.tokens.push(VideoEvents.subscribe(b,a));},onProfileButtonClick:function(a){VideoChatView._invokeCore('onProfileButtonClick',a);},unload:function(){while(VideoChatView.tokens.length)VideoEvents.unsubscribe(VideoChatView.tokens.pop());},mightReloadPostInstall:function(){return ua.windows();},_showDialog:function(b,a){new Dialog().setAllowCrossPageTransition(true).setTop(a?85:125).setAsync(new AsyncRequest(b)).show();},_onIncomingCall:function(a,b){VideoChatView.inIncomingCall=true;VideoChatView._showDialog(URI('/ajax/chat/video/incoming_call.php').setQueryData({idTarget:b.idTarget,callId:b.callId}),true);},onOutgoingCall:function(a){VideoChatView.inOutgoingCall=true;VideoChatView._showDialog('/ajax/chat/video/outgoing_call.php?idTarget='+a);},_checkPriorState:function(){if(VideoChatView.mightReloadPostInstall()){var a=getCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);if(a){clearCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);var b=getCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(b){clearCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(getCookie(VideoChatView.TARGET_ID_COOKIE_KEY))return;if(VideoChatPlugin.isInstalled())VideoChatView.onOutgoingCall(b);}}}},_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatViewCore',function(){VideoChatView.initCore();VideoChatView[b].apply(VideoChatView,a);});}};
__e("GroupChatController",["arbiter","ChatConfig","dom","css-core","PageTransitions"],function(h,j,i,g){var a=j('arbiter');var c=j('ChatConfig');var d=j('dom');var b=j('css-core');var f=j('PageTransitions');function e(l,m,n){_goOnlineText=d.find(l,'.fbGroupChatGoOnline');_chatWithGroupText=d.find(l,'.fbGroupChatOpenTab');function k(){if(Chat.isOnline()){b.hide(_goOnlineText);b.show(_chatWithGroupText);}else{b.hide(_chatWithGroupText);b.show(_goOnlineText);}}_visibilitySubscription=a.subscribe('chat/visibility-changed',k);f.registerHandler(a.unsubscribe.bind(a,_visibilitySubscription));Event.listen(l,'click',function(){if(c.get('mercury_integration')){j.ensure(['ChatController'],function(o){o.raiseGroupTab(m);});}else Chat.goOnline(function(){Chat.openTab(m,n,'group');});});}i.exports=e;});
__e("presence-arbiter-message",[],function(b,d,c,a){b.PresenceMessage=c.exports={STARTED:'presence/started',SHUTDOWN:'presence/shutdown',RESTARTED:'presence/restarted',WINDOW_RESIZED:'presence/window-resized',TAB_CLOSED:'presence/tab-closed',TAB_OPENED:'presence/tab-opened',PRESENCE_UPDATER_READY:'presence/updater-ready',getAppMessageType:function(e,f){return 'presence/app_message:'+e+':'+f;},getArbiterMessageType:function(e){return 'presence/message:'+e;}};},3);